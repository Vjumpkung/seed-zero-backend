name: Main job

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.ref_name }}
  cancel-in-progress: true

env:
  GCP_PROJECT_ID: seed-zero
  GCP_SERVICE_ACCOUNT: githubdeploy@seed-zero.iam.gserviceaccount.com
  GCP_SA_KEY: |
    {
      "type": "service_account",
      "project_id": "seed-zero",
      "private_key_id": "87ceab1abd9d86f0c4d1c59fa6696cc439cb0ba0",
      "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCwKi/tk12AL9Kb\n7mNE4Dk6kTeIMkkxQPZlTceBpJIOUt6QNG5ZqpJV8a0TOxLFuyGOJ+47pdC3tTYT\ndIEVAYiHJsUYrQHGc4YmIkegXSTmFSdwFFFl0uaUwQEuNf10M4LyrrUVWofjk5bb\nh4HSXObd+YlVLRjDe5LahoISf0GB8n4KoNd05YhZSvDHJ0N3+c2ALNaWG8ARWQ6a\nfWSF9KhmrQaMij1vTRrBkZnvmjA2cGrEoA0FAjjPJS6bqU/LKvSs+IQTADlWpgD8\ns7NAKQAswHo8bYAcXEcT54YAV5Bor9gM8mZXYpuAoCszjY+R0sNdLSjXWvgzcjsq\nV/AZBEKDAgMBAAECggEAVdbYr80E3HdxCmYonOEdQbqM8qJ+I6/h4A78TeGhAbXD\nmUTTGIIS+CnhCePZC9xZR2mRniL4BuwXw3cbht7OZfywQYvbt5WHIoHFoRCB8FMS\nenyMBS+1B3rcVmYccEjBX/tdZWBNosjB04q96YE3RaZYEtb8oBRQxIaSTu0PQH/X\nL9U/0Jf1rM8hAAncTuC2tolJKiAMpqPl19roDb13YTa6IRS6ZQJdtXX78Cl2iFYU\niqw5b+J2Mp1TRde7OXk2KzQMtLHE2KJoKaL3fPqGBkxMM92IEqFXpll/+kDQkZ+B\n027FCD+RfQzcUueqRuM520Z/OzKZHF1h58HsKxPPoQKBgQDhqByFfWloGyFkVREd\niJugKZt/mirvua1Et7q/pSrEmzRMsDTYZmgAIr3jrsnP17Gi6YZRviLVXlsJMOre\nLU0SF4yAcZT7gwMjTLMKU80bjIt8tJMom1VL8kw28NYm8yNWzhRsJjoiMr4vUkJy\n/C9H/FK6zOHeeG8WjoIpeWnOeQKBgQDH2mSDbhVR2+e8AaPD95GQ/VwYqxebjlr+\nfgS/xsE5FdUEgx5jsKirapwZGIswLSJOk2Diq1ISg1f92qFyjY6/rSYsw/NJKKph\nC8yC5K3UfW2+T5xsL3SpNGuXf/y3N07QZK8waF8FPGNLrbL24ufr0HDIraSYgyYs\nT75WDBlp2wKBgQDhXhGmLHuScs4ls2PVmDK9gfCAP0u0gj+PSuPjNSUCmHNiR/Vv\nTs99mzUE6PM7dhM+PnZcu0V0zbij9EwNuzam5Af52/ZMPytqHNcPcGR/qB1DXeE/\nA+vrXsFJebyXx+q6bjUtUfxrXTxebIxa5IygG1vQnoDSvHtODuPmYhEPGQKBgCJ3\n2RQN3WFz4uC7C6qVvSZbfBHJGFY81BbGVz1YIyUcTdPsZUZeRojh5zAw2nihoCQb\nKP+O+qW0v21J0sR2A6OtUkMwPHpmqBP6u/frRsu6Ij5Lbrf960nvf4ruiQB0aoRo\niQp5RcIaaym3OIF6GvPBzGHgCN5A6EmGK1ad2Zg3AoGBANTo0wK+rd5T4G+knpBr\nmRaCy+FzMH5u9FP0lxIDaq8NFA6jezqqLv/iuDq7ywbr37Lmr0pVHH9AfcsWlKcL\nD5wAaDNhWZaCQ4cMH+4I8YT/WYucZ7v6aacYRoQoIkEa+/k9BpF4GNjcQix27mIT\nak7Au66iLqERivDJkMnzbyZC\n-----END PRIVATE KEY-----\n",
      "client_email": "githubdeploy@seed-zero.iam.gserviceaccount.com",
      "client_id": "102943534705601907734",
      "auth_uri": "https://accounts.google.com/o/oauth2/auth",
      "token_uri": "https://oauth2.googleapis.com/token",
      "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
      "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/githubdeploy%40seed-zero.iam.gserviceaccount.com"
    }
  GCP_SA_FILE: publish.json
  GCP_SA_KEY_ENCODED: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAic2VlZC16ZXJvIiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiMGY1NzlhNDU5ZTRmODJkMDlmMTRkOWIzNDAxZGM5MzJkZjIxMzgzOCIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZnSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2d3Z2dTa0FnRUFBb0lCQVFDNXRCMUdhdGNYb2twQVxuYWVFVEhmUWhvRG9hclhFNUhDNDJXRVRONlFobFRZWm5BRkNacU5EbFFmcTh3NzJPWFk3Mjg0OHZJMXlmaVVGYlxuNC9Qa05jUUFDL1JRZVlRN250OHhqMnF0T2k3aHhtUDFqU0Z4S2prckM4dW85elBxY08zWmJFdWFlTHNYNHEwSFxudk4ydW1jVjByNXphRTNJc0xUcW1iM2xDQUVHZ1BWdk1RNGNNYzRFL2laanRRM2ZqeHVwQWoyZzFFMG1BekgyQlxuM1FZdkcwRGlrN0p4NGRUUi96Z3d1Qjd1TDZ3OTVPays4U2ZFK21EM3JMYjNmeGhGUkFkc01TRSsvS2lKdW5LdVxuY01pcEFtdURVK2I5OVJlVm1MdnJQNS9GQzJidllWRVcvczc0b1VPMGhOY0xJZzd0N0pnRzNqWlBIS25LK3l4SFxuRys4eUFESWxBZ01CQUFFQ2dnRUFJcW05SVN6R00zSW1tL2xuZXRNSGc5Tk5wVGNrd0QxRFh2K0E4RktFTDZ5VlxuM3RvUE1XOXlkcWluTGQ3M25nQld0RC9vUlNzN21jZmIvRlFEYldDZjBrWm85ekNIZnoxN2VkdkVWTXRjZnVZeVxuT0Y1OGxJd0dHY1BjNHhBcGo2UStzV3ZtZk5IMlVsSU1iRHBUd3NpUE0rV255SWtDc2I1TGlVK2JlYmRraUkwNVxuM3JJdGNmQWpVRHRTaDY3Z2M4NzFSS1pPaEZtZWpQTHNjNGpyYWFEZENVTWN4aWRlMjhKNnRVSXRnYVZZVUhwQlxueENyd1Q2cXNyWEZad2tMQTBIb2cxaFgzWGJrWnViK0hFV2t6WTUwakRBY0VUT2R1aWZNcWgzay96RnRReVpPalxuV05nYUt2K0hVSTNRMVkrWHk1djdkMU0xUnpUajlDRnFjd1g1L1ZkSnJRS0JnUURxUnZBZ3pTaTdVOGVvdlhDdVxucVpOZkVKeWZlay8wZ0ZrTmMxOERpbHc4QjZvTVM5UHB6N21lZTV2NXlHMTJhQ2VESDc1S204bTdYMjhRNDNIblxuUlVZZHFSRnd2THl2anZwazJRR3FMS2M4WHF4bCtWMXRySnZEMHRzWmpwcCtYdnFrcHQ0ZzQxQU9zclZpbTVHK1xuZ0ZaWmpWMUtHRFVCTFhlN2NtS3lZTEw5ZndLQmdRREs3QzVWc1FuL3NWRHFuciszL1hac3Z5a21Ja2s1bmdyUVxudFhZRWJvb2FBbnVIeHlzWENWdnJkQzBFWm9LSHZ6WGUzSjE2R2NtOTJMeTc5SVpXRStwaHRoY2tUZXd4UVYrZ1xuVXZMV2V0YWp2cmV4MGtURE9VcU9jVURiNVdOdHJ0ZElpeGZaTzQ2a1psZElxMmZ3UTZkaHRaSW5hSVR4VUxRZ1xuTUtXZzhsYnFXd0tCZ0RrdldadllHRElwa0JuTEsvOG1XMWVnR1dzQUV4WXVZZzViYy96TVFCbFRFWm53eEdoVlxuRVF6elJTNWlVdjNOREtBQUZwWGxrd2RPa3pDL0krVjh6bEdkSENtMW1DVU9OR1o3WmVHaEJxMUF1cm9sZFQyNVxuSFVoZVpxYkZYVWF0Ym1iVWFISUVxbHo4R0RSYW51ZXVNZVdvRVBadUZEb1dYQnlBSGtGR1EwcUhBb0dCQUxNTVxuQmk0eUVlSjhzQ3IwZTdGNmdWMmVwazR4Zm03S1ZqeWxnRWFVeW1IOHdzYWhKQklsZmVlWkVJZUxjNjBYT0E4MlxubGZUQWdGTjB3OE1NRk9RcW1tb3c0dVp6b3U0ckFwZFIyVmNKK0ExdklHSlVaN3ZoOXprTUVQQjF6RzloRUMvQVxuR3dEZ0hoSk5Bc0xxQ3NIaXovUFU0K3JGdkZlNG45YXZWZFZYUHYxMUFvR0JBSWlQWmtXQU1seXRrNE95SFpnOFxuTFhrQmRiNEs0WmhxdnhrSWV5RTc2WEcySlVTOHJndTZvUE9LbWJaMFBvaW1lanoyWWhEeG5oMGo0OGQ3NVRjQVxuVTZCYk11Tjk5UGxiWkk1b3l5UForSWlrNFRiTGdJYTkzSmMyZnA1VjhvTzFCRElKa3lXaTJERndBa3lTRmFCRlxuU1lXSk5saEY3NmJKTGU0b3hmZ2dsNTN2XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAiZ2l0aHViZGVwbG95QHNlZWQtemVyby5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgImNsaWVudF9pZCI6ICIxMDI5NDM1MzQ3MDU2MDE5MDc3MzQiLAogICJhdXRoX3VyaSI6ICJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vby9vYXV0aDIvYXV0aCIsCiAgInRva2VuX3VyaSI6ICJodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiIsCiAgImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLAogICJjbGllbnRfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9yb2JvdC92MS9tZXRhZGF0YS94NTA5L2dpdGh1YmRlcGxveSU0MHNlZWQtemVyby5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIKfQ==
  GCP_SA_KEY_ENCODED2: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAic2VlZC16ZXJvIiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiMGY1NzlhNDU5ZTRmODJkMDlmMTRkOWIzNDAxZGM5MzJkZjIxMzgzOCIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZnSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2d3Z2dTa0FnRUFBb0lCQVFDNXRCMUdhdGNYb2twQVxuYWVFVEhmUWhvRG9hclhFNUhDNDJXRVRONlFobFRZWm5BRkNacU5EbFFmcTh3NzJPWFk3Mjg0OHZJMXlmaVVGYlxuNC9Qa05jUUFDL1JRZVlRN250OHhqMnF0T2k3aHhtUDFqU0Z4S2prckM4dW85elBxY08zWmJFdWFlTHNYNHEwSFxudk4ydW1jVjByNXphRTNJc0xUcW1iM2xDQUVHZ1BWdk1RNGNNYzRFL2laanRRM2ZqeHVwQWoyZzFFMG1BekgyQlxuM1FZdkcwRGlrN0p4NGRUUi96Z3d1Qjd1TDZ3OTVPays4U2ZFK21EM3JMYjNmeGhGUkFkc01TRSsvS2lKdW5LdVxuY01pcEFtdURVK2I5OVJlVm1MdnJQNS9GQzJidllWRVcvczc0b1VPMGhOY0xJZzd0N0pnRzNqWlBIS25LK3l4SFxuRys4eUFESWxBZ01CQUFFQ2dnRUFJcW05SVN6R00zSW1tL2xuZXRNSGc5Tk5wVGNrd0QxRFh2K0E4RktFTDZ5VlxuM3RvUE1XOXlkcWluTGQ3M25nQld0RC9vUlNzN21jZmIvRlFEYldDZjBrWm85ekNIZnoxN2VkdkVWTXRjZnVZeVxuT0Y1OGxJd0dHY1BjNHhBcGo2UStzV3ZtZk5IMlVsSU1iRHBUd3NpUE0rV255SWtDc2I1TGlVK2JlYmRraUkwNVxuM3JJdGNmQWpVRHRTaDY3Z2M4NzFSS1pPaEZtZWpQTHNjNGpyYWFEZENVTWN4aWRlMjhKNnRVSXRnYVZZVUhwQlxueENyd1Q2cXNyWEZad2tMQTBIb2cxaFgzWGJrWnViK0hFV2t6WTUwakRBY0VUT2R1aWZNcWgzay96RnRReVpPalxuV05nYUt2K0hVSTNRMVkrWHk1djdkMU0xUnpUajlDRnFjd1g1L1ZkSnJRS0JnUURxUnZBZ3pTaTdVOGVvdlhDdVxucVpOZkVKeWZlay8wZ0ZrTmMxOERpbHc4QjZvTVM5UHB6N21lZTV2NXlHMTJhQ2VESDc1S204bTdYMjhRNDNIblxuUlVZZHFSRnd2THl2anZwazJRR3FMS2M4WHF4bCtWMXRySnZEMHRzWmpwcCtYdnFrcHQ0ZzQxQU9zclZpbTVHK1xuZ0ZaWmpWMUtHRFVCTFhlN2NtS3lZTEw5ZndLQmdRREs3QzVWc1FuL3NWRHFuciszL1hac3Z5a21Ja2s1bmdyUVxudFhZRWJvb2FBbnVIeHlzWENWdnJkQzBFWm9LSHZ6WGUzSjE2R2NtOTJMeTc5SVpXRStwaHRoY2tUZXd4UVYrZ1xuVXZMV2V0YWp2cmV4MGtURE9VcU9jVURiNVdOdHJ0ZElpeGZaTzQ2a1psZElxMmZ3UTZkaHRaSW5hSVR4VUxRZ1xuTUtXZzhsYnFXd0tCZ0RrdldadllHRElwa0JuTEsvOG1XMWVnR1dzQUV4WXVZZzViYy96TVFCbFRFWm53eEdoVlxuRVF6elJTNWlVdjNOREtBQUZwWGxrd2RPa3pDL0krVjh6bEdkSENtMW1DVU9OR1o3WmVHaEJxMUF1cm9sZFQyNVxuSFVoZVpxYkZYVWF0Ym1iVWFISUVxbHo4R0RSYW51ZXVNZVdvRVBadUZEb1dYQnlBSGtGR1EwcUhBb0dCQUxNTVxuQmk0eUVlSjhzQ3IwZTdGNmdWMmVwazR4Zm03S1ZqeWxnRWFVeW1IOHdzYWhKQklsZmVlWkVJZUxjNjBYT0E4MlxubGZUQWdGTjB3OE1NRk9RcW1tb3c0dVp6b3U0ckFwZFIyVmNKK0ExdklHSlVaN3ZoOXprTUVQQjF6RzloRUMvQVxuR3dEZ0hoSk5Bc0xxQ3NIaXovUFU0K3JGdkZlNG45YXZWZFZYUHYxMUFvR0JBSWlQWmtXQU1seXRrNE95SFpnOFxuTFhrQmRiNEs0WmhxdnhrSWV5RTc2WEcySlVTOHJndTZvUE9LbWJaMFBvaW1lanoyWWhEeG5oMGo0OGQ3NVRjQVxuVTZCYk11Tjk5UGxiWkk1b3l5UForSWlrNFRiTGdJYTkzSmMyZnA1VjhvTzFCRElKa3lXaTJERndBa3lTRmFCRlxuU1lXSk5saEY3NmJKTGU0b3hmZ2dsNTN2XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAiZ2l0aHViZGVwbG95QHNlZWQtemVyby5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgImNsaWVudF9pZCI6ICIxMDI5NDM1MzQ3MDU2MDE5MDc3MzQiLAogICJhdXRoX3VyaSI6ICJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vby9vYXV0aDIvYXV0aCIsCiAgInRva2VuX3VyaSI6ICJodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiIsCiAgImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLAogICJjbGllbnRfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9yb2JvdC92MS9tZXRhZGF0YS94NTA5L2dpdGh1YmRlcGxveSU0MHNlZWQtemVyby5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIKfQo=
  SERVICE_NAME: ${{ github.event.repository.name }}
  SERVICE_REGION: asia-southeast1

jobs:
  deploy-main:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    if: github.ref_name == 'main'
    steps:
      - uses: actions/checkout@v3
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v0
        with:
          project_id: seed-zero
          service_account_key: $GCP_SA_KEY
          export_default_credentials: true
      - name: Use gcloud CLI
        run: |
          gcloud run deploy $SERVICE_NAME \
          --quiet \
          --set-env-vars="NAME=starter-code" \
          --region $SERVICE_REGION \
          --source . \
          --project $GCP_PROJECT_ID \
          --labels "commit-sha=${{ github.sha }}" \
          --service-account $GCP_SERVICE_ACCOUNT
      - name: Config policy to allow unauthenticated
        run: |
          gcloud run services add-iam-policy-binding $SERVICE_NAME \
          --quiet \
          --region $SERVICE_REGION \
          --member="allUsers" \
          --role="roles/run.invoker"
