name: Main job

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.ref_name }}
  cancel-in-progress: true

env:
  GCP_PROJECT_ID: seed-zero
  GCP_SERVICE_ACCOUNT: githubdeploy@seed-zero.iam.gserviceaccount.com
  GCP_SA_KEY: |
    {
      "type": "service_account",
      "project_id": "seed-zero",
      "private_key_id": "0f579a459e4f82d09f14d9b3401dc932df213838",
      "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC5tB1GatcXokpA\naeETHfQhoDoarXE5HC42WETN6QhlTYZnAFCZqNDlQfq8w72OXY72848vI1yfiUFb\n4/PkNcQAC/RQeYQ7nt8xj2qtOi7hxmP1jSFxKjkrC8uo9zPqcO3ZbEuaeLsX4q0H\nvN2umcV0r5zaE3IsLTqmb3lCAEGgPVvMQ4cMc4E/iZjtQ3fjxupAj2g1E0mAzH2B\n3QYvG0Dik7Jx4dTR/zgwuB7uL6w95Ok+8SfE+mD3rLb3fxhFRAdsMSE+/KiJunKu\ncMipAmuDU+b99ReVmLvrP5/FC2bvYVEW/s74oUO0hNcLIg7t7JgG3jZPHKnK+yxH\nG+8yADIlAgMBAAECggEAIqm9ISzGM3Imm/lnetMHg9NNpTckwD1DXv+A8FKEL6yV\n3toPMW9ydqinLd73ngBWtD/oRSs7mcfb/FQDbWCf0kZo9zCHfz17edvEVMtcfuYy\nOF58lIwGGcPc4xApj6Q+sWvmfNH2UlIMbDpTwsiPM+WnyIkCsb5LiU+bebdkiI05\n3rItcfAjUDtSh67gc871RKZOhFmejPLsc4jraaDdCUMcxide28J6tUItgaVYUHpB\nxCrwT6qsrXFZwkLA0Hog1hX3XbkZub+HEWkzY50jDAcETOduifMqh3k/zFtQyZOj\nWNgaKv+HUI3Q1Y+Xy5v7d1M1RzTj9CFqcwX5/VdJrQKBgQDqRvAgzSi7U8eovXCu\nqZNfEJyfek/0gFkNc18Dilw8B6oMS9Ppz7mee5v5yG12aCeDH75Km8m7X28Q43Hn\nRUYdqRFwvLyvjvpk2QGqLKc8Xqxl+V1trJvD0tsZjpp+Xvqkpt4g41AOsrVim5G+\ngFZZjV1KGDUBLXe7cmKyYLL9fwKBgQDK7C5VsQn/sVDqnr+3/XZsvykmIkk5ngrQ\ntXYEbooaAnuHxysXCVvrdC0EZoKHvzXe3J16Gcm92Ly79IZWE+phthckTewxQV+g\nUvLWetajvrex0kTDOUqOcUDb5WNtrtdIixfZO46kZldIq2fwQ6dhtZInaITxULQg\nMKWg8lbqWwKBgDkvWZvYGDIpkBnLK/8mW1egGWsAExYuYg5bc/zMQBlTEZnwxGhV\nEQzzRS5iUv3NDKAAFpXlkwdOkzC/I+V8zlGdHCm1mCUONGZ7ZeGhBq1AuroldT25\nHUheZqbFXUatbmbUaHIEqlz8GDRanueuMeWoEPZuFDoWXByAHkFGQ0qHAoGBALMM\nBi4yEeJ8sCr0e7F6gV2epk4xfm7KVjylgEaUymH8wsahJBIlfeeZEIeLc60XOA82\nlfTAgFN0w8MMFOQqmmow4uZzou4rApdR2VcJ+A1vIGJUZ7vh9zkMEPB1zG9hEC/A\nGwDgHhJNAsLqCsHiz/PU4+rFvFe4n9avVdVXPv11AoGBAIiPZkWAMlytk4OyHZg8\nLXkBdb4K4ZhqvxkIeyE76XG2JUS8rgu6oPOKmbZ0Poimejz2YhDxnh0j48d75TcA\nU6BbMuN99PlbZI5oyyPZ+Iik4TbLgIa93Jc2fp5V8oO1BDIJkyWi2DFwAkySFaBF\nSYWJNlhF76bJLe4oxfggl53v\n-----END PRIVATE KEY-----\n",
      "client_email": "githubdeploy@seed-zero.iam.gserviceaccount.com",
      "client_id": "102943534705601907734",
      "auth_uri": "https://accounts.google.com/o/oauth2/auth",
      "token_uri": "https://oauth2.googleapis.com/token",
      "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
      "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/githubdeploy%40seed-zero.iam.gserviceaccount.com"
    }
  GCP_SA_FILE: publish.json
  GCP_SA_KEY_ENCODED: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAic2VlZC16ZXJvIiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiMGY1NzlhNDU5ZTRmODJkMDlmMTRkOWIzNDAxZGM5MzJkZjIxMzgzOCIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZnSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2d3Z2dTa0FnRUFBb0lCQVFDNXRCMUdhdGNYb2twQVxuYWVFVEhmUWhvRG9hclhFNUhDNDJXRVRONlFobFRZWm5BRkNacU5EbFFmcTh3NzJPWFk3Mjg0OHZJMXlmaVVGYlxuNC9Qa05jUUFDL1JRZVlRN250OHhqMnF0T2k3aHhtUDFqU0Z4S2prckM4dW85elBxY08zWmJFdWFlTHNYNHEwSFxudk4ydW1jVjByNXphRTNJc0xUcW1iM2xDQUVHZ1BWdk1RNGNNYzRFL2laanRRM2ZqeHVwQWoyZzFFMG1BekgyQlxuM1FZdkcwRGlrN0p4NGRUUi96Z3d1Qjd1TDZ3OTVPays4U2ZFK21EM3JMYjNmeGhGUkFkc01TRSsvS2lKdW5LdVxuY01pcEFtdURVK2I5OVJlVm1MdnJQNS9GQzJidllWRVcvczc0b1VPMGhOY0xJZzd0N0pnRzNqWlBIS25LK3l4SFxuRys4eUFESWxBZ01CQUFFQ2dnRUFJcW05SVN6R00zSW1tL2xuZXRNSGc5Tk5wVGNrd0QxRFh2K0E4RktFTDZ5VlxuM3RvUE1XOXlkcWluTGQ3M25nQld0RC9vUlNzN21jZmIvRlFEYldDZjBrWm85ekNIZnoxN2VkdkVWTXRjZnVZeVxuT0Y1OGxJd0dHY1BjNHhBcGo2UStzV3ZtZk5IMlVsSU1iRHBUd3NpUE0rV255SWtDc2I1TGlVK2JlYmRraUkwNVxuM3JJdGNmQWpVRHRTaDY3Z2M4NzFSS1pPaEZtZWpQTHNjNGpyYWFEZENVTWN4aWRlMjhKNnRVSXRnYVZZVUhwQlxueENyd1Q2cXNyWEZad2tMQTBIb2cxaFgzWGJrWnViK0hFV2t6WTUwakRBY0VUT2R1aWZNcWgzay96RnRReVpPalxuV05nYUt2K0hVSTNRMVkrWHk1djdkMU0xUnpUajlDRnFjd1g1L1ZkSnJRS0JnUURxUnZBZ3pTaTdVOGVvdlhDdVxucVpOZkVKeWZlay8wZ0ZrTmMxOERpbHc4QjZvTVM5UHB6N21lZTV2NXlHMTJhQ2VESDc1S204bTdYMjhRNDNIblxuUlVZZHFSRnd2THl2anZwazJRR3FMS2M4WHF4bCtWMXRySnZEMHRzWmpwcCtYdnFrcHQ0ZzQxQU9zclZpbTVHK1xuZ0ZaWmpWMUtHRFVCTFhlN2NtS3lZTEw5ZndLQmdRREs3QzVWc1FuL3NWRHFuciszL1hac3Z5a21Ja2s1bmdyUVxudFhZRWJvb2FBbnVIeHlzWENWdnJkQzBFWm9LSHZ6WGUzSjE2R2NtOTJMeTc5SVpXRStwaHRoY2tUZXd4UVYrZ1xuVXZMV2V0YWp2cmV4MGtURE9VcU9jVURiNVdOdHJ0ZElpeGZaTzQ2a1psZElxMmZ3UTZkaHRaSW5hSVR4VUxRZ1xuTUtXZzhsYnFXd0tCZ0RrdldadllHRElwa0JuTEsvOG1XMWVnR1dzQUV4WXVZZzViYy96TVFCbFRFWm53eEdoVlxuRVF6elJTNWlVdjNOREtBQUZwWGxrd2RPa3pDL0krVjh6bEdkSENtMW1DVU9OR1o3WmVHaEJxMUF1cm9sZFQyNVxuSFVoZVpxYkZYVWF0Ym1iVWFISUVxbHo4R0RSYW51ZXVNZVdvRVBadUZEb1dYQnlBSGtGR1EwcUhBb0dCQUxNTVxuQmk0eUVlSjhzQ3IwZTdGNmdWMmVwazR4Zm03S1ZqeWxnRWFVeW1IOHdzYWhKQklsZmVlWkVJZUxjNjBYT0E4MlxubGZUQWdGTjB3OE1NRk9RcW1tb3c0dVp6b3U0ckFwZFIyVmNKK0ExdklHSlVaN3ZoOXprTUVQQjF6RzloRUMvQVxuR3dEZ0hoSk5Bc0xxQ3NIaXovUFU0K3JGdkZlNG45YXZWZFZYUHYxMUFvR0JBSWlQWmtXQU1seXRrNE95SFpnOFxuTFhrQmRiNEs0WmhxdnhrSWV5RTc2WEcySlVTOHJndTZvUE9LbWJaMFBvaW1lanoyWWhEeG5oMGo0OGQ3NVRjQVxuVTZCYk11Tjk5UGxiWkk1b3l5UForSWlrNFRiTGdJYTkzSmMyZnA1VjhvTzFCRElKa3lXaTJERndBa3lTRmFCRlxuU1lXSk5saEY3NmJKTGU0b3hmZ2dsNTN2XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAiZ2l0aHViZGVwbG95QHNlZWQtemVyby5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgImNsaWVudF9pZCI6ICIxMDI5NDM1MzQ3MDU2MDE5MDc3MzQiLAogICJhdXRoX3VyaSI6ICJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vby9vYXV0aDIvYXV0aCIsCiAgInRva2VuX3VyaSI6ICJodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiIsCiAgImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLAogICJjbGllbnRfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9yb2JvdC92MS9tZXRhZGF0YS94NTA5L2dpdGh1YmRlcGxveSU0MHNlZWQtemVyby5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIKfQ==
  GCP_SA_KEY_ENCODED2: ew0KICAidHlwZSI6ICJzZXJ2aWNlX2FjY291bnQiLA0KICAicHJvamVjdF9pZCI6ICJzZWVkLXplcm8iLA0KICAicHJpdmF0ZV9rZXlfaWQiOiAiMGY1NzlhNDU5ZTRmODJkMDlmMTRkOWIzNDAxZGM5MzJkZjIxMzgzOCIsDQogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRQzV0QjFHYXRjWG9rcEFcbmFlRVRIZlFob0RvYXJYRTVIQzQyV0VUTjZRaGxUWVpuQUZDWnFORGxRZnE4dzcyT1hZNzI4NDh2STF5ZmlVRmJcbjQvUGtOY1FBQy9SUWVZUTdudDh4ajJxdE9pN2h4bVAxalNGeEtqa3JDOHVvOXpQcWNPM1piRXVhZUxzWDRxMEhcbnZOMnVtY1YwcjV6YUUzSXNMVHFtYjNsQ0FFR2dQVnZNUTRjTWM0RS9pWmp0UTNmanh1cEFqMmcxRTBtQXpIMkJcbjNRWXZHMERpazdKeDRkVFIvemd3dUI3dUw2dzk1T2srOFNmRSttRDNyTGIzZnhoRlJBZHNNU0UrL0tpSnVuS3VcbmNNaXBBbXVEVStiOTlSZVZtTHZyUDUvRkMyYnZZVkVXL3M3NG9VTzBoTmNMSWc3dDdKZ0czalpQSEtuSyt5eEhcbkcrOHlBRElsQWdNQkFBRUNnZ0VBSXFtOUlTekdNM0ltbS9sbmV0TUhnOU5OcFRja3dEMURYditBOEZLRUw2eVZcbjN0b1BNVzl5ZHFpbkxkNzNuZ0JXdEQvb1JTczdtY2ZiL0ZRRGJXQ2Ywa1pvOXpDSGZ6MTdlZHZFVk10Y2Z1WXlcbk9GNThsSXdHR2NQYzR4QXBqNlErc1d2bWZOSDJVbElNYkRwVHdzaVBNK1dueUlrQ3NiNUxpVStiZWJka2lJMDVcbjNySXRjZkFqVUR0U2g2N2djODcxUktaT2hGbWVqUExzYzRqcmFhRGRDVU1jeGlkZTI4SjZ0VUl0Z2FWWVVIcEJcbnhDcndUNnFzclhGWndrTEEwSG9nMWhYM1hia1p1YitIRVdrelk1MGpEQWNFVE9kdWlmTXFoM2svekZ0UXlaT2pcbldOZ2FLditIVUkzUTFZK1h5NXY3ZDFNMVJ6VGo5Q0ZxY3dYNS9WZEpyUUtCZ1FEcVJ2QWd6U2k3VThlb3ZYQ3VcbnFaTmZFSnlmZWsvMGdGa05jMThEaWx3OEI2b01TOVBwejdtZWU1djV5RzEyYUNlREg3NUttOG03WDI4UTQzSG5cblJVWWRxUkZ3dkx5dmp2cGsyUUdxTEtjOFhxeGwrVjF0ckp2RDB0c1pqcHArWHZxa3B0NGc0MUFPc3JWaW01RytcbmdGWlpqVjFLR0RVQkxYZTdjbUt5WUxMOWZ3S0JnUURLN0M1VnNRbi9zVkRxbnIrMy9YWnN2eWttSWtrNW5nclFcbnRYWUVib29hQW51SHh5c1hDVnZyZEMwRVpvS0h2elhlM0oxNkdjbTkyTHk3OUlaV0UrcGh0aGNrVGV3eFFWK2dcblV2TFdldGFqdnJleDBrVERPVXFPY1VEYjVXTnRydGRJaXhmWk80NmtabGRJcTJmd1E2ZGh0WkluYUlUeFVMUWdcbk1LV2c4bGJxV3dLQmdEa3ZXWnZZR0RJcGtCbkxLLzhtVzFlZ0dXc0FFeFl1WWc1YmMvek1RQmxURVpud3hHaFZcbkVRenpSUzVpVXYzTkRLQUFGcFhsa3dkT2t6Qy9JK1Y4emxHZEhDbTFtQ1VPTkdaN1plR2hCcTFBdXJvbGRUMjVcbkhVaGVacWJGWFVhdGJtYlVhSElFcWx6OEdEUmFudWV1TWVXb0VQWnVGRG9XWEJ5QUhrRkdRMHFIQW9HQkFMTU1cbkJpNHlFZUo4c0NyMGU3RjZnVjJlcGs0eGZtN0tWanlsZ0VhVXltSDh3c2FoSkJJbGZlZVpFSWVMYzYwWE9BODJcbmxmVEFnRk4wdzhNTUZPUXFtbW93NHVaem91NHJBcGRSMlZjSitBMXZJR0pVWjd2aDl6a01FUEIxekc5aEVDL0Fcbkd3RGdIaEpOQXNMcUNzSGl6L1BVNCtyRnZGZTRuOWF2VmRWWFB2MTFBb0dCQUlpUFprV0FNbHl0azRPeUhaZzhcbkxYa0JkYjRLNFpocXZ4a0lleUU3NlhHMkpVUzhyZ3U2b1BPS21iWjBQb2ltZWp6MlloRHhuaDBqNDhkNzVUY0FcblU2QmJNdU45OVBsYlpJNW95eVBaK0lpazRUYkxnSWE5M0pjMmZwNVY4b08xQkRJSmt5V2kyREZ3QWt5U0ZhQkZcblNZV0pObGhGNzZiSkxlNG94ZmdnbDUzdlxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwNCiAgImNsaWVudF9lbWFpbCI6ICJnaXRodWJkZXBsb3lAc2VlZC16ZXJvLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwNCiAgImNsaWVudF9pZCI6ICIxMDI5NDM1MzQ3MDU2MDE5MDc3MzQiLA0KICAiYXV0aF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLA0KICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwNCiAgImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLA0KICAiY2xpZW50X3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9naXRodWJkZXBsb3klNDBzZWVkLXplcm8uaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iDQp9
  SERVICE_NAME: ${{ github.event.repository.name }}
  SERVICE_REGION: asia-southeast1

jobs:
  deploy-main:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    if: github.ref_name == 'main'
    steps:
      - uses: actions/checkout@v3
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v0
        with:
          project_id: seed-zero
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true
      - name: Use gcloud CLI
        run: |
          gcloud run deploy $SERVICE_NAME \
          --quiet \
          --set-env-vars="NAME=starter-code" \
          --region $SERVICE_REGION \
          --source . \
          --project $GCP_PROJECT_ID \
          --labels "commit-sha=${{ github.sha }}" \
          --service-account $GCP_SERVICE_ACCOUNT
      - name: Config policy to allow unauthenticated
        run: |
          gcloud run services add-iam-policy-binding $SERVICE_NAME \
          --quiet \
          --region $SERVICE_REGION \
          --member="allUsers" \
          --role="roles/run.invoker"
